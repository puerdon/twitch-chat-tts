<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<style type="text/css">
		body {
			background-color: #191919;
			color: white;
		}
	</style>
	<script type="text/javascript" src="./tmi.min.js">
		
	</script>
</head>
<body>
	 <form>
      <label for="txt">Enter text</label>
      <input id="txt" type="text" class="txt" />
      <!-- <div>
        <label for="rate">Rate</label
        ><input type="range" min="0.5" max="2" value="1" step="0.1" id="rate" />
        <div class="rate-value">1</div>
        <div class="clearfix"></div>
      </div>
      <div>
        <label for="pitch">Pitch</label
        ><input type="range" min="0" max="2" value="1" step="0.1" id="pitch" />
        <div class="pitch-value">1</div>
        <div class="clearfix"></div>
      </div> -->
      <h1>Available voices: </h1>
      <select></select>
      <div class="controls">
        <button id="play" type="submit">Play</button>
      </div>
    </form>

    <h1>Enter the channel name you want to listen to:</h1>
	<input type="text" id="handle" name="handle" value="han__bao">
	<button id="ok">OK</button>	<div id="container">
		
	</div>
	<script>
		// blacklist: don't read these ids' messages
		const blacklist = ["Streamlabs"];
		let setIntervalID = -1;
		let hasEnabledVoice = false;
		let last_username = "";

		const blank_utt = new SpeechSynthesisUtterance("");
		blank_utt.volume = 0;
		// blank_utt.onend = function (e) {
		// 	console.log(`${e.elapsedTime} seconds. `)
		// }

		// document.addEventListener("click", () => {
		// 	console.log('clicked!');
		// 	if (hasEnabledVoice) {
		// 		return;
		// 	}
		// 	const l = new SpeechSynthesisUtterance('hello');
		// 	l.volume = 0.5;
		// 	synth.speak(l);
		// 	hasEnabledVoice = true;
		// })

		// Web Speech API
		const synth = window.speechSynthesis;
		console.log(synth.getVoices());
		
		const div = document.getElementById("container");
		
		document.getElementById("ok").addEventListener("click", start_client);

		function beep() {
			synth.speak(blank_utt);
			console.log("beep");
		}



		function start_client() {
			console.log('clicked!');
			if (hasEnabledVoice) {
				return;
			}
			const l = new SpeechSynthesisUtterance('hello');
			l.volume = 0.5;
			synth.speak(l);
			hasEnabledVoice = true;

			setIntervalID = setInterval(beep, 500);


			const channel = document.getElementById('handle').value;
			const client = new tmi.Client({
				options: { debug: true },
				identity: {

				},
				channels: [ channel ]
			});
			client.connect().catch(console.error);
			client.on('message', (channel, tags, message, self) => {
				if(self || blacklist.includes(tags['display-name']) ) return;
				console.log(message);
				console.log(tags);
				var msg_to_read = removeEmote(tags, message);
				
				// show message on the screen
				const node = document.createElement("p");
				const textnode = document.createTextNode(`${tags['display-name']}: ${message}`);
				node.appendChild(textnode);
				div.appendChild(node);

				
				let speaker = new SpeechSynthesisUtterance(username(tags['display-name']) + ' says');
				speaker.onstart = function(e) {
					console.log('start reading username');
					// NoMsg = false;
					clearInterval(setIntervalID);
				}
				// synth.speak(speaker);

				console.log('asdf')
				if (last_username != tags['display-name']) {
					synth.speak(speaker);
				} else {
					synth.speak(blank_utt);
				}

				last_username = tags['display-name'];
				

				let utterance = new SpeechSynthesisUtterance(msg_to_read);
				utterance.onend = function(e) {
					console.log('ending reading message');
					// NoMsg = true;
					setIntervalID = setInterval(beep, 500);
				}
				synth.speak(utterance);
			});
		}

		// while (1) {
		// 	if (hasEnabledVoice && NoMsg) {
		// 		console.log('toooo')
		// 		synth.speak(blank_utt);
		// 	}
		// }

		

		function username(name) {
			console.log(name);
			switch (name) {
				case 'Maskedsound':
					return "Josiah's butler";
				case 'KellayeGoh':
					return "Han's sister";
				case 'EdArrowz':
					return "Han's number one fan";
				case 'MifyMiff':
					return "sussy game lover";
				case 'WheelerKK':
					return "KKJ";
				case 'collyoxenfree':
					return "Gritty";

				default:
					return name;
			}

		}

		function removeEmote(tags, message) {
			
			if (!tags['emotes']) {
				return message;
			} else {
				var m = message;
				var emotes = [];
				for (const key in tags['emotes']) {
					var char_range = tags['emotes'][key][0];
					// console.log(char_range);
					// console.log(`message: ${message}`);
					var start_pos = parseInt(char_range.split('-')[0]);
					var end_pos = parseInt(char_range.split('-')[1]);
					// console.log('start_pos:', start_pos);
					// console.log('end_pos:', end_pos);
					// console.log('m', m);
					// console.log(m[end_pos]);

					var emote_str = m.substring(start_pos, end_pos + 1);
					console.log("emote_str: ", emote_str);
					emotes.push(emote_str);
				}

				emotes.forEach(e => {
					m = m.replaceAll(e, "");	
				})

				return m;
			}

		}



		// 
		const inputForm = document.querySelector("form");
		const inputTxt = document.querySelector(".txt");
		const voiceSelect = document.querySelector("select");

		// const pitch = document.querySelector("#pitch");
		// const pitchValue = document.querySelector(".pitch-value");
		// const rate = document.querySelector("#rate");
		// const rateValue = document.querySelector(".rate-value");

		let voices = [];

		function populateVoiceList() {
		  voices = synth.getVoices().sort(function (a, b) {
		    const aname = a.name.toUpperCase();
		    const bname = b.name.toUpperCase();

		    if (aname < bname) {
		      return -1;
		    } else if (aname == bname) {
		      return 0;
		    } else {
		      return +1;
		    }
		  });
		  console.log(voiceSelect.selectedIndex);
		  const selectedIndex =
		    voiceSelect.selectedIndex < 0 ? 0 : voiceSelect.selectedIndex;
		  voiceSelect.innerHTML = "";

		  for (let i = 0; i < voices.length; i++) {
		    const option = document.createElement("option");
		    option.textContent = `${voices[i].name} (${voices[i].lang})`;

		    if (voices[i].default) {
		      option.textContent += " -- DEFAULT";
		    }

		    option.setAttribute("data-lang", voices[i].lang);
		    option.setAttribute("data-name", voices[i].name);
		    voiceSelect.appendChild(option);
		  }
		  voiceSelect.selectedIndex = selectedIndex;
		}

		populateVoiceList();

		if (speechSynthesis.onvoiceschanged !== undefined) {
		  speechSynthesis.onvoiceschanged = populateVoiceList;
		}

		function speak() {
		  if (synth.speaking) {
		    console.error("speechSynthesis.speaking");
		    return;
		  }

		  if (inputTxt.value !== "") {
		    const utterThis = new SpeechSynthesisUtterance(inputTxt.value);

		    utterThis.onend = function (event) {
		      console.log("SpeechSynthesisUtterance.onend");
		    };

		    utterThis.onerror = function (event) {
		      console.error("SpeechSynthesisUtterance.onerror");
		    };

		    const selectedOption =
		      voiceSelect.selectedOptions[0].getAttribute("data-name");

		    for (let i = 0; i < voices.length; i++) {
		      if (voices[i].name === selectedOption) {
		        utterThis.voice = voices[i];
		        break;
		      }
		    }
		    // utterThis.pitch = pitch.value;
		    // utterThis.rate = rate.value;
		    synth.speak(utterThis);
		  }
		}

		inputForm.onsubmit = function (event) {
		  event.preventDefault();

		  speak();

		  inputTxt.blur();
		};

		// pitch.onchange = function () {
		//   pitchValue.textContent = pitch.value;
		// };

		// rate.onchange = function () {
		//   rateValue.textContent = rate.value;
		// };

		voiceSelect.onchange = function () {
		  speak();
		};

	</script>
</body>
</html>